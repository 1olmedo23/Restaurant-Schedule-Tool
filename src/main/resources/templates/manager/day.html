<th:block th:replace="~{layout :: base(~{::section})}">
    <section>
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1 class="h4 mb-0"
                    th:text="${#temporals.dayOfWeekName(date)} + ' ' + ${#temporals.format(date,'MM/dd/yyyy')}">
                    Day
                </h1>
                <div class="text-muted small">
                    <span th:if="${param.saved}">Saved.</span>
                    <span th:if="${param.cleared}">Cleared.</span>
                    <span th:if="${error}" th:text="${error}"></span>
                </div>
            </div>
            <div>
                <a class="btn btn-outline-secondary me-2"
                   th:href="@{'/manager/schedule/' + ${#temporals.format(prevDate,'yyyy-MM-dd')}}">Prev</a>
                <a class="btn btn-outline-secondary"
                   th:href="@{'/manager/schedule/' + ${#temporals.format(nextDate,'yyyy-MM-dd')}}">Next</a>
            </div>
        </div>

        <!-- Approved time off badges for this specific day -->
        <div class="mt-3"
             th:if="${timeOffNamesForDay != null and #lists.size(timeOffNamesForDay) > 0}">
    <span class="badge bg-info text-dark me-1"
          th:each="n : ${timeOffNamesForDay}"
          th:text="${'Time off: ' + n}">
        Time off: Name
    </span>
        </div>

        <div th:if="${locked}" class="alert alert-warning mt-3 text-center">
            This date is in a <strong>POSTED</strong> period. Normal saving is disabled.
            Use <strong>“Save (Edit)”</strong> or <strong>“Clear (Edit)”</strong> to record changes.
        </div>

        <div th:if="${param.saved}" class="alert alert-success alert-dismissible fade show mt-3" role="alert">
            Saved assignments.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <form class="mt-3"
              th:action="@{'/manager/schedule/' + ${#temporals.format(date,'yyyy-MM-dd')}}"
              method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <!-- Hidden override flag toggled by the yellow buttons -->
            <input type="hidden" id="override" name="override" value="0"/>

            <div class="table-responsive">
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                    <tr><th style="width:120px;">Shift</th><th style="width:160px;">Role</th><th>Assign</th></tr>
                    </thead>
                    <tbody>
                    <!-- LUNCH -->
                    <tr class="table-secondary"><th colspan="3">Lunch</th></tr>

                    <tr th:each="role : ${lunchRoles}">
                        <td>Lunch</td>
                        <td th:text="${role.label()}"></td>
                        <td>
                            <!-- availability-based -->
                            <select class="form-select role-select role-select-filtered"
                                    th:id="${role.key()} + '_filtered'"
                                    th:name="${role.key()}">
                                <option value="">— Select —</option>

                                <!-- Manager role: managers only (available) -->
                                <option th:if="${role.key() == 'role_LUNCH_MANAGER'}"
                                        th:each="u : ${availableLunchManagers}"
                                        th:value="${u.username}"
                                        th:text="${u.fullName + ' (' + u.username + ')'}"
                                        th:selected="${saved[role.key()] == u.username}">
                                </option>

                                <!-- Other lunch roles: employees + managers (available) -->
                                <option th:if="${role.key() != 'role_LUNCH_MANAGER'}"
                                        th:each="u : ${availableLunchStaff}"
                                        th:value="${u.username}"
                                        th:text="${u.fullName + ' (' + u.username + ')'}"
                                        th:selected="${saved[role.key()] == u.username}">
                                </option>
                            </select>

                            <!-- Amendment hint -->
                            <div class="text-warning small mt-1"
                                 th:if="${amended[__${role.key()}__] != null}">
                                Edited: <span th:text="${amended[__${role.key()}__]}"></span>
                            </div>

                            <!-- override: all eligible users -->
                            <select class="form-select role-select role-select-all d-none mt-2"
                                    th:id="${role.key()} + '_all'"
                                    disabled>
                                <option value="">— Select (override) —</option>

                                <!-- Manager override: managers only -->
                                <option th:if="${role.key() == 'role_LUNCH_MANAGER'}"
                                        th:each="u : ${allManagers}"
                                        th:value="${u.username}"
                                        th:text="${u.fullName + ' (' + u.username + ')'}"
                                        th:selected="${saved[role.key()] == u.username}">
                                </option>

                                <!-- Other lunch overrides: all staff -->
                                <option th:if="${role.key() != 'role_LUNCH_MANAGER'}"
                                        th:each="u : ${allStaff}"
                                        th:value="${u.username}"
                                        th:text="${u.fullName + ' (' + u.username + ')'}"
                                        th:selected="${saved[role.key()] == u.username}">
                                </option>
                            </select>

                            <div class="form-check mt-2">
                                <input class="form-check-input override-checkbox" type="checkbox"
                                       th:id="${role.key()} + '_override'"
                                       th:attr="data-role=${role.key()}">
                                <label class="form-check-label small" th:for="${role.key()} + '_override'">
                                    Override availability (show all)
                                </label>
                            </div>
                        </td>
                    </tr>

                    <!-- DINNER -->
                    <tr class="table-secondary"><th colspan="3">Dinner</th></tr>

                    <tr th:each="role : ${dinnerRoles}">
                        <td>Dinner</td>
                        <td th:text="${role.label()}"></td>
                        <td>
                            <!-- availability-based -->
                            <select class="form-select role-select role-select-filtered"
                                    th:id="${role.key()} + '_filtered'"
                                    th:name="${role.key()}">
                                <option value="">— Select —</option>
                                <option th:each="u : ${availableDinnerStaff}"
                                        th:value="${u.username}"
                                        th:text="${u.fullName + ' (' + u.username + ')'}"
                                        th:selected="${saved[role.key()] == u.username}">
                                </option>
                            </select>

                            <!-- Amendment hint -->
                            <div class="text-warning small mt-1"
                                 th:if="${amended[__${role.key()}__] != null}">
                                Edited: <span th:text="${amended[__${role.key()}__]}"></span>
                            </div>

                            <!-- override: all staff -->
                            <select class="form-select role-select role-select-all d-none mt-2"
                                    th:id="${role.key()} + '_all'"
                                    disabled>
                                <option value="">— Select (override) —</option>
                                <option th:each="u : ${allStaff}"
                                        th:value="${u.username}"
                                        th:text="${u.fullName + ' (' + u.username + ')'}"
                                        th:selected="${saved[role.key()] == u.username}">
                                </option>
                            </select>

                            <div class="form-check mt-2">
                                <input class="form-check-input override-checkbox" type="checkbox"
                                       th:id="${role.key()} + '_override'"
                                       th:attr="data-role=${role.key()}">
                                <label class="form-check-label small" th:for="${role.key()} + '_override'">
                                    Override availability (show all)
                                </label>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Buttons when NOT locked -->
            <div class="d-flex gap-2" th:if="${!locked}">
                <button class="btn btn-primary" type="submit" name="action" value="save">Save</button>
                <button class="btn btn-outline-danger" type="submit" name="action" value="clear"
                        onclick="return confirm('Clear all assignments for this date?')">Clear All</button>
            </div>

            <!-- Buttons when locked (force override=1) -->
            <div class="d-flex gap-2" th:if="${locked}">
                <button type="submit" class="btn btn-warning"
                        name="action" value="save"
                        onclick="document.getElementById('override').value='1'">
                    Save (Edit)
                </button>
                <button class="btn btn-outline-danger" type="submit" name="action" value="clear"
                        onclick="document.getElementById('override').value='1'; return confirm('Clear all assignments for this date?')">
                    Clear (Edit)
                </button>
            </div>
        </form>

        <script>
            // Toggle between filtered and "all staff" selects per role
            document.querySelectorAll('.override-checkbox').forEach(cb => {
                cb.addEventListener('change', e => {
                    const role = e.target.getAttribute('data-role');
                    const filtered = document.getElementById(role + '_filtered');
                    const allSel   = document.getElementById(role + '_all');

                    if (e.target.checked) {
                        allSel.classList.remove('d-none');
                        allSel.disabled = false;
                        allSel.name = role;
                        allSel.value = filtered.value;

                        filtered.classList.add('d-none');
                        filtered.disabled = true;
                        filtered.removeAttribute('name');
                    } else {
                        filtered.classList.remove('d-none');
                        filtered.disabled = false;
                        filtered.name = role;
                        filtered.value = allSel.value;

                        allSel.classList.add('d-none');
                        allSel.disabled = true;
                        allSel.removeAttribute('name');
                    }
                });
            });
        </script>
    </section>
</th:block>
