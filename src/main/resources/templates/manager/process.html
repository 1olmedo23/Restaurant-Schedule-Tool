<th:block th:with="active='manager-process-requests'" th:replace="~{layout :: base(~{::section})}">
    <section>
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 class="h4 mb-0">Process Requests</h1>
            <form class="d-flex gap-2" method="get" th:action="@{/manager/requests/process}">
                <input class="form-control form-control-sm" type="date" name="start" th:value="${start}" />
                <input class="form-control form-control-sm" type="date" name="end" th:value="${end}" />
                <button class="btn btn-sm btn-outline-secondary">Filter</button>
            </form>
        </div>

        <div th:if="${param.approved}" class="alert alert-success">Approved.</div>
        <div th:if="${param.denied}" class="alert alert-warning">Denied.</div>
        <div th:if="${param.error}" class="alert alert-danger" th:text="${param.error}"></div>

        <div class="table-responsive">
            <table class="table table-sm align-middle">
                <thead><tr><th>ID</th><th>Type</th><th>Date</th><th>Requester</th><th>Receiver</th><th>Receiver OK?</th><th>Decide</th></tr></thead>
                <tbody>
                <tr th:each="r : ${pending}">
                    <td th:text="${r.id}">1</td>
                    <td th:text="${r.type}">TRADE</td>
                    <td th:text="${r.requestDate}">2025-07-01</td>
                    <td th:text="${r.requester.fullName}">Alice</td>
                    <td th:text="${r.receiver != null ? r.receiver.fullName : ''}"></td>
                    <td>
          <span th:if="${r.type.name()=='TRADE'}" class="badge"
                th:classappend="${r.receiverConfirmed ? 'bg-success' : 'bg-secondary'}"
                th:text="${r.receiverConfirmed ? 'Confirmed' : 'Pending'}"></span>
                    </td>
                    <td>
                        <!-- APPROVE form -->
                        <form class="d-inline" method="post" th:action="@{|/manager/requests/${r.id}/approve|}">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                            <input class="form-control form-control-sm d-inline-block"
                                   style="width:220px"
                                   name="note"
                                   placeholder="Optional note"/>

                            <button class="btn btn-sm btn-success ms-1">
                                Approve
                            </button>

                            <!-- Override checkbox only for TRADE + receiver not yet confirmed -->
                            <div class="form-check form-check-inline ms-1"
                                 th:if="${r.type.name()=='TRADE' && !r.receiverConfirmed}">
                                <input class="form-check-input"
                                       type="checkbox"
                                       name="override"
                                       value="true"
                                       th:id="'override_' + ${r.id}" />
                                <label class="form-check-label small"
                                       th:for="'override_' + ${r.id}">
                                    Override
                                </label>
                            </div>
                        </form>

                        <!-- DENY form (no override here) -->
                        <form class="d-inline ms-1" method="post" th:action="@{|/manager/requests/${r.id}/deny|}">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <input class="form-control form-control-sm d-inline-block"
                                   style="width:220px"
                                   name="note"
                                   placeholder="Optional note"/>
                            <button class="btn btn-sm btn-outline-danger">Deny</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>
</th:block>
