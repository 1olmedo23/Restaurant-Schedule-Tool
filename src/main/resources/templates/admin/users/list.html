<th:block th:with="active='admin-users'"
          th:replace="~{layout :: base(~{::section})}">
    <section>
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h4 mb-3">Users</h1>
            <a class="btn btn-primary" th:href="@{/admin/users/new}">New User</a>
        </div>

        <div th:if="${created}" class="alert alert-success">User created.</div>
        <div th:if="${toggled}" class="alert alert-info">User status updated.</div>
        <div th:if="${deleted}" class="alert alert-warning">User deleted.</div>
        <div th:if="${error}" class="alert alert-danger" th:text="${error}">Error</div>

        <div class="table-responsive">
            <table class="table table-striped align-middle">
                <thead>
                <tr>
                    <th>ID</th><th>Username</th><th>Name</th><th>Email</th>
                    <th>Roles</th><th>Enabled</th><th style="width:220px;">Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="u : ${users}">
                    <td th:text="${u.id}">1</td>
                    <td th:text="${u.username}">alice</td>
                    <td th:text="${u.fullName}">Alice User</td>
                    <!-- Escape the @ in fallback text to avoid IDE warning -->
                    <td th:text="${u.email}">alice&#64;example.com</td>
                    <td>
                        <span class="badge bg-secondary me-1" th:each="r : ${u.roles}" th:text="${r.name}">EMPLOYEE</span>
                    </td>
                    <td>
                        <span th:if="${u.enabled}" class="badge bg-success">Yes</span>
                        <span th:unless="${u.enabled}" class="badge bg-secondary">No</span>
                    </td>
                    <td>
                        <div class="d-flex gap-2">
                            <!-- Toggle Enable/Disable (hide for yourself) -->
                            <form th:if="${u.username != #authentication.name}"
                                  th:action="@{'/admin/users/' + ${u.id} + '/toggle'}" method="post"
                                  class="js-confirm"
                                  th:attr="data-confirm=${u.enabled} ? 'Disable ' + u.username + '?' : 'Enable ' + u.username + '?'">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button class="btn"
                                        th:classappend="${u.enabled} ? 'btn-outline-danger' : 'btn-outline-success'"
                                        th:text="${u.enabled} ? 'Disable' : 'Enable'">Toggle</button>
                            </form>

                            <!-- Delete (hide for yourself) -->
                            <form th:if="${u.username != #authentication.name}"
                                  th:action="@{'/admin/users/' + ${u.id} + '/delete'}" method="post"
                                  class="js-confirm"
                                  th:attr="data-confirm='Permanently delete ' + u.username + '? This cannot be undone.'">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button class="btn btn-outline-secondary">Delete</button>
                            </form>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <script>
            // simple confirmation prompts
            document.querySelectorAll('.js-confirm').forEach(f => {
                f.addEventListener('submit', function(e){
                    const msg = this.getAttribute('data-confirm') || 'Are you sure?';
                    if(!confirm(msg)) e.preventDefault();
                });
            });
        </script>
    </section>
</th:block>
