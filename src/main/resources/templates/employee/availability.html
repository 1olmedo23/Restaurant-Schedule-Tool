<th:block xmlns:th="http://www.thymeleaf.org"
          xmlns:sec="https://www.thymeleaf.org/extras/spring-security"
          th:with="active='employee-availability'"
          th:replace="~{layout :: base(~{::section})}">
    <section>
        <h1 class="h4 mb-3">My Availability (Tue–Sat)</h1>
        <form method="post" th:action="@{/employee/availability}">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <div class="table-responsive">
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                    <tr><th>Day</th><th>Lunch</th><th>Dinner</th></tr>
                    </thead>
                    <tbody>
                    <tr th:each="d : ${weekdays}">
                        <td th:text="${d}">TUESDAY</td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox"
                                       th:name="${'lunch_' + d.name()}"
                                       th:checked="${avail[d.name()] != null and (avail[d.name()]['lunch'] == true)}">
                            </div>
                        </td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox"
                                       th:name="${'dinner_' + d.name()}"
                                       th:checked="${avail[d.name()] != null and (avail[d.name()]['dinner'] == true)}">
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <button class="btn btn-primary"
                    type="submit"
                    onclick="return confirm('Are you sure you want to save your availability changes?');">
                Save Availability
            </button>
            <span th:if="${param.saved}" class="ms-2 text-success">Submitted</span>

            <div class="mt-2 small">
                <span th:if="${availabilityStatus == 'PENDING'}" class="text-warning">
                    Status: Pending manager approval
                </span>
                <span th:if="${availabilityStatus == 'DENIED'}" class="text-danger">
                    Status: Denied – please adjust your availability and save again.
                </span>
                <span th:if="${availabilityStatus == 'APPROVED'}" class="text-success">
                    Status: Approved
                </span>
            </div>
        </form>

        <!-- Manager-only pending availability queue -->
        <div class="mt-4" sec:authorize="hasRole('MANAGER')">
            <h2 class="h5 mb-3">Pending Availability Requests</h2>

            <p th:if="${#lists.isEmpty(pendingUsers)}" class="text-muted">
                No pending availability requests.
            </p>

            <div th:if="${!#lists.isEmpty(pendingUsers)}" class="table-responsive">
                <table class="table table-sm table-bordered align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>Employee</th>
                        <th>Requested Availability</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="u : ${pendingUsers}">
                        <td th:text="${u.fullName}">Employee Name</td>

                        <!-- Requested pattern: simple day x lunch/dinner grid -->
                        <td>
                            <div class="table-responsive">
                                <table class="table table-borderless table-sm mb-1">
                                    <thead>
                                    <tr>
                                        <th>Day</th>
                                        <th>Lunch</th>
                                        <th>Dinner</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="d : ${weekdays}">
                                        <td th:text="${d}">TUESDAY</td>
                                        <td>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" disabled
                                                       th:checked="${
                                                 pendingAvailabilities[u.id] != null
                                                 and pendingAvailabilities[u.id][d.name()] != null
                                                 and (
                                                     pendingAvailabilities[u.id][d.name()].requestedLunchAvailable != null
                                                     ? pendingAvailabilities[u.id][d.name()].requestedLunchAvailable
                                                     : pendingAvailabilities[u.id][d.name()].lunchAvailable
                                                 )
                                               }">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" disabled
                                                       th:checked="${
                                                 pendingAvailabilities[u.id] != null
                                                 and pendingAvailabilities[u.id][d.name()] != null
                                                 and (
                                                     pendingAvailabilities[u.id][d.name()].requestedDinnerAvailable != null
                                                     ? pendingAvailabilities[u.id][d.name()].requestedDinnerAvailable
                                                     : pendingAvailabilities[u.id][d.name()].dinnerAvailable
                                                 )
                                               }">
                                            </div>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </td>

                        <!-- Approve / Deny buttons -->
                        <td>
                            <form th:action="@{|/manager/availability/user/${u.id}/approve|}"
                                  method="post"
                                  class="d-inline">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button class="btn btn-sm btn-success"
                                        type="submit"
                                        onclick="return confirm('Approve this availability request?');">
                                    Approve
                                </button>
                            </form>

                            <form th:action="@{|/manager/availability/user/${u.id}/deny|}"
                                  method="post"
                                  class="d-inline ms-1">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button class="btn btn-sm btn-outline-danger"
                                        type="submit"
                                        onclick="return confirm('Deny this availability request?');">
                                    Deny
                                </button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</th:block>
